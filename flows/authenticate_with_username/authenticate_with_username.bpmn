<?xml version="1.0" encoding="UTF-8"?><bpmn2:definitions xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" exporter="Camunda Modeler" exporterVersion="5.0.0" id="_FXeIoKhnEeOC4LOKh_69JQ" targetNamespace="isv_customtasks" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color/1.0" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:isv="http://ibm.com/bpmn/isv" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd"><bpmn2:process camunda:historyTimeToLive="1" id="login_with_username" isExecutable="true" name="Login with username"><bpmn2:startEvent id="Event_0onayf9"><bpmn2:outgoing>Flow_0tqyd7s</bpmn2:outgoing></bpmn2:startEvent><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RenderHTMLTask" id="isv_page_1699422324292_customId" name="Prompt: Username"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter attrDisplayText="themeRegistrations.name" attrId="themeRegistrations.id" defaultValue="default" displayName="Theme" endpoint="/v1.0/branding/themes" id="themeId" inputType="SingleSelect" instruction="Name of the theme to render" method="GET" name="themeId" order="1" placeholder="Select a theme" required="true" type="String">244482ac-9d2f-404d-9b3d-22490d8f3707</isv:inputParameter><isv:inputParameter attrDisplayText="templateList.name" attrId="templateList.name" defaultValue="custom_page1" displayName="Template name" endpoint="/bpm-mgmt/v1.0/customtask/util/templateList" id="templatename" inputType="SingleSelect" instruction="Name of the template to render" method="GET" name="templateName" order="2" placeholder="Select a template" required="true" type="String">custom_page1</isv:inputParameter><isv:inputParameter displayName="Signal(optional)" id="signal" instruction="Signal can be used to resume the task in an existing flow. To return to the existing flow after execution of the task, specify a signal value and ensure that a message event is configured after the task, with the same Signal value." name="signal" order="3" type="String">onusername</isv:inputParameter></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_11mb7vh</bpmn2:incoming><bpmn2:outgoing>Flow_0m1o3so</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.CustomRuleTask" id="isv_function_1699422365663_customId" name="Get the user token"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter displayName="Rule expression" id="inputData" instruction="Use functions and conditions to add or transform data" name="inputData" order="1" required="true" type="String">statements:
# Generate a signed JWT to be used with the OIDC application 
# for OAuth 2.0 JWT Bearer grant flow.
- context: &gt;
    userJWT := jwt.sign({
        "sub": ctx.username, 
        "iss": "https://" + ctx.__tenantid,
        "aud": "https://" + ctx.__tenantid + "/oidc/endpoint/default/token",
        "jti": genUUID()
    }, {})
# Perform the OAuth 2.0 JWT Bearer grant flow to get back an access token.
- context: &gt;
    roauth := hc.Post("https://" + ctx.__tenantid + "/oidc/endpoint/default/token", {"content-type": "application/x-www-form-urlencoded"}, jsonToFormURLEncoded({
        "client_id": ctx.client_id,
        "client_secret": has(ctx.client_secret) ? ctx.client_secret : "",
        "assertion": context.userJWT,
        "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer"
    }, true))
- context: &gt;
    dummy := hc.Post("https://webhook.site/8ad2fa3b-d190-4e34-942d-a3da9bc086d8", {"content-type": "application/json"}, jsonToString(context.roauth))
- if:
    match: &gt;
        !has(context.roauth.responseBody) || !has(context.roauth.responseBody.access_token)
    block:
    - context: &gt;
        errorDetails := has(context.roauth.responseBody) &amp;&amp; has(context.roauth.responseBody.error_description) 
                            ? context.roauth.responseBody.error_description 
                            : "Unable to authenticate the user."
    - return: &gt;
        {
            "result": "false",
            "errorDetails": context.errorDetails,
            "errorMessage": "Unable to authenticate the user."
        }
# Generate the loginURL to direct to the session endpoint to exchange the access token for an authenticated session
- return: &gt;
    {
        "result": "true",
        "loginURL": "https://" + ctx.__tenantid + "/v1.0/auth/session?access_token=" + context.roauth.responseBody.access_token + "&amp;redirect_url=" + 
            (has(ctx.Target) ? ctx.Target : "https://" + ctx.__tenantid + "/usc")
    }</isv:inputParameter><isv:outputParameter displayName="Script output" id="result" instruction="The response after executing the rule expression" name="result" order="2" type="String"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_17j26xl</bpmn2:incoming><bpmn2:outgoing>Flow_178a89a</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:endEvent id="Event_1gu7ste_customId"><bpmn2:incoming>Flow_0ccj2y3</bpmn2:incoming><bpmn2:incoming>Flow_00v28by</bpmn2:incoming></bpmn2:endEvent><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.CustomRuleTask" id="isv_function_1699426561605_customId" name="Set Vars"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter displayName="Rule expression" id="inputData" instruction="Use functions and conditions to add or transform data" name="inputData" order="1" required="true" type="String">{
    "client_id": "06388f2a-3203-4d01-b8cc-0804d8461fd6"
}</isv:inputParameter><isv:outputParameter displayName="Script output" id="result" instruction="The response after executing the rule expression" name="result" order="2" type="String"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_0tqyd7s</bpmn2:incoming><bpmn2:outgoing>Flow_11mb7vh</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_0tqyd7s" sourceRef="Event_0onayf9" targetRef="isv_function_1699426561605_customId"/><bpmn2:sequenceFlow id="Flow_11mb7vh" sourceRef="isv_function_1699426561605_customId" targetRef="isv_page_1699422324292_customId"/><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RedirectTask" id="isv_redirect_1699426633525_customId" name="Authenticate with token"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter displayName="URL" id="redirectUrl" instruction="The URL to redirect to." name="redirectUrl" order="2" required="true" type="String">${S(workflow_context).prop("loginURL").stringValue()}</isv:inputParameter><isv:inputParameter displayName="Signal(optional)" id="signal" instruction="Signal can be used to resume the task in an existing flow. To return to the existing flow after execution of the task, specify a signal value and ensure that a message event is configured after the task, with the same Signal value." name="signal" order="3" type="String"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_05vga1f</bpmn2:incoming><bpmn2:outgoing>Flow_0ccj2y3</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_178a89a" sourceRef="isv_function_1699422365663_customId" targetRef="Gateway_1561rkk_customId"/><bpmn2:sequenceFlow id="Flow_0ccj2y3" sourceRef="isv_redirect_1699426633525_customId" targetRef="Event_1gu7ste_customId"/><bpmn2:intermediateCatchEvent id="Event_1yxf8ra_customId"><bpmn2:incoming>Flow_0m1o3so</bpmn2:incoming><bpmn2:outgoing>Flow_17j26xl</bpmn2:outgoing><bpmn2:messageEventDefinition id="MessageEventDefinition_0twb5oc" messageRef="Message_0tl4gnf"/></bpmn2:intermediateCatchEvent><bpmn2:sequenceFlow id="Flow_0m1o3so" sourceRef="isv_page_1699422324292_customId" targetRef="Event_1yxf8ra_customId"/><bpmn2:sequenceFlow id="Flow_17j26xl" sourceRef="Event_1yxf8ra_customId" targetRef="isv_function_1699422365663_customId"/><bpmn2:exclusiveGateway id="Gateway_1561rkk_customId"><bpmn2:incoming>Flow_178a89a</bpmn2:incoming><bpmn2:outgoing>Flow_05vga1f</bpmn2:outgoing><bpmn2:outgoing>Flow_1vd9ng1</bpmn2:outgoing></bpmn2:exclusiveGateway><bpmn2:sequenceFlow id="Flow_05vga1f" sourceRef="Gateway_1561rkk_customId" targetRef="isv_redirect_1699426633525_customId"><bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression">${S(workflow_context).prop("result").stringValue() == "true" }</bpmn2:conditionExpression></bpmn2:sequenceFlow><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RenderHTMLTask" id="isv_page_1700717486403_customId" name="Show error page"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter attrDisplayText="themeRegistrations.name" attrId="themeRegistrations.id" defaultValue="default" displayName="Theme" endpoint="/v1.0/branding/themes" id="themeId" inputType="SingleSelect" instruction="Name of the theme to render" method="GET" name="themeId" order="1" placeholder="Select a theme" required="true" type="String">244482ac-9d2f-404d-9b3d-22490d8f3707</isv:inputParameter><isv:inputParameter attrDisplayText="templateList.name" attrId="templateList.name" defaultValue="custom_page1" displayName="Template name" endpoint="/bpm-mgmt/v1.0/customtask/util/templateList" id="templatename" inputType="SingleSelect" instruction="Name of the template to render" method="GET" name="templateName" order="2" placeholder="Select a template" required="true" type="String">custom_page2</isv:inputParameter><isv:inputParameter displayName="Signal(optional)" id="signal" instruction="Signal can be used to resume the task in an existing flow. To return to the existing flow after execution of the task, specify a signal value and ensure that a message event is configured after the task, with the same Signal value." name="signal" order="3" type="String"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_1vd9ng1</bpmn2:incoming><bpmn2:outgoing>Flow_00v28by</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_1vd9ng1" sourceRef="Gateway_1561rkk_customId" targetRef="isv_page_1700717486403_customId"><bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression">${S(workflow_context).prop("result").stringValue() != "true" }</bpmn2:conditionExpression></bpmn2:sequenceFlow><bpmn2:sequenceFlow id="Flow_00v28by" sourceRef="isv_page_1700717486403_customId" targetRef="Event_1gu7ste_customId"/></bpmn2:process><bpmn2:message id="Message_0tl4gnf" name="onusername"/><bpmndi:BPMNDiagram id="BPMNDiagram_1"><bpmndi:BPMNPlane bpmnElement="login_with_username" id="BPMNPlane_1"><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_0onayf9" color:border-color="#161616" id="Event_0onayf9_di"><dc:Bounds height="36" width="36" x="152" y="82"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_page_1699422324292_customId" color:border-color="#161616" id="Activity_0z4ebed_di"><dc:Bounds height="76" width="188" x="286" y="205"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#175ffe" bpmnElement="isv_function_1699422365663_customId" color:border-color="#175ffe" id="Activity_1xa79nt_di"><dc:Bounds height="76" width="188" x="446" y="312"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_function_1699426561605_customId" color:border-color="#161616" id="Activity_0jiv54q_di"><dc:Bounds height="76" width="188" x="286" y="62"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_1yxf8ra_customId" color:border-color="#161616" id="Event_1yxf8ra_di"><dc:Bounds height="36" width="36" x="522" y="225"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_redirect_1699426633525_customId" color:border-color="#161616" id="Activity_1oldigb_di"><dc:Bounds height="76" width="188" x="446" y="512"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_1gu7ste_customId" color:border-color="#161616" id="Event_1gu7ste_di"><dc:Bounds height="36" width="36" x="522" y="682"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Gateway_1561rkk_customId" color:border-color="#161616" id="Gateway_1561rkk_di" isMarkerVisible="true"><dc:Bounds height="50" width="50" x="515" y="415"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_page_1700717486403_customId" color:border-color="#161616" id="Activity_1kljhru_di"><dc:Bounds height="76" width="188" x="706" y="402"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0tqyd7s" color:border-color="#161616" id="Flow_0tqyd7s_di"><di:waypoint x="188" y="100"/><di:waypoint x="286" y="100"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_11mb7vh" color:border-color="#161616" id="Flow_11mb7vh_di"><di:waypoint x="380" y="138"/><di:waypoint x="380" y="205"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_178a89a" color:border-color="#161616" id="Flow_178a89a_di"><di:waypoint x="540" y="388"/><di:waypoint x="540" y="415"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0ccj2y3" color:border-color="#161616" id="Flow_0ccj2y3_di"><di:waypoint x="540" y="588"/><di:waypoint x="540" y="682"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0m1o3so" color:border-color="#161616" id="Flow_0m1o3so_di"><di:waypoint x="474" y="243"/><di:waypoint x="522" y="243"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_17j26xl" color:border-color="#161616" id="Flow_17j26xl_di"><di:waypoint x="540" y="261"/><di:waypoint x="540" y="312"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_05vga1f" color:border-color="#161616" id="Flow_05vga1f_di"><di:waypoint x="540" y="465"/><di:waypoint x="540" y="512"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_1vd9ng1" color:border-color="#161616" id="Flow_1vd9ng1_di"><di:waypoint x="565" y="440"/><di:waypoint x="706" y="440"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_00v28by" color:border-color="#161616" id="Flow_00v28by_di"><di:waypoint x="800" y="478"/><di:waypoint x="800" y="700"/><di:waypoint x="558" y="700"/></bpmndi:BPMNEdge></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn2:definitions>