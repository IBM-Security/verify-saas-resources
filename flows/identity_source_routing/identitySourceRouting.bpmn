<?xml version="1.0" encoding="UTF-8"?><bpmn2:definitions xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" exporter="Camunda Modeler" exporterVersion="5.0.0" id="_FXeIoKhnEeOC4LOKh_69JQ" targetNamespace="isv_customtasks" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color/1.0" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:isv="http://ibm.com/bpmn/isv" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd"><bpmn2:process camunda:historyTimeToLive="1" id="identity_source_routing" isExecutable="true" isv:propertiesSchemaVersion="1.0" name="Identity Source Routing"><bpmn2:startEvent camunda:displayName="Start event" id="Event_0onayf9"><bpmn2:outgoing>Flow_1w02h0s</bpmn2:outgoing></bpmn2:startEvent><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RenderHTMLTask" id="isv_page_1693487581300_customId" name="Ask Username"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter id="themeId" name="themeId">67cafc3b-f8d6-490a-b654-1bc16ec899d3</isv:inputParameter><isv:inputParameter id="templatename" name="templateName">custom_page1</isv:inputParameter><isv:inputParameter id="callback" name="callback"/><isv:inputParameter id="signal" name="signal">ifa</isv:inputParameter></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_1w02h0s</bpmn2:incoming><bpmn2:outgoing>Flow_0x5fq5m</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_1w02h0s" sourceRef="Event_0onayf9" targetRef="isv_page_1693487581300_customId"/><bpmn2:intermediateCatchEvent id="Event_0vtdtpv_customId"><bpmn2:incoming>Flow_0x5fq5m</bpmn2:incoming><bpmn2:outgoing>Flow_1gkbetj</bpmn2:outgoing><bpmn2:messageEventDefinition id="MessageEventDefinition_1potozk" messageRef="Message_08k7kfh"/></bpmn2:intermediateCatchEvent><bpmn2:endEvent camunda:displayName="End event" id="Event_0fzzuo8_customId"><bpmn2:incoming>Flow_0j7k9ud</bpmn2:incoming><bpmn2:incoming>Flow_0bd3oto</bpmn2:incoming></bpmn2:endEvent><bpmn2:sequenceFlow id="Flow_0x5fq5m" sourceRef="isv_page_1693487581300_customId" targetRef="Event_0vtdtpv_customId"/><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.CustomRuleTask" id="isv_function_1693487621614_customId" name="Compute Login URL"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter id="inputData" name="inputData">statements:

# This is the map of email domain to identity source realm
- context: &gt; 
    idsMap := {
        "gmail.com": "www.google.com",
        "in.ibm.com": "www.ibm.com",
        "default": "cloudIdentityRealm"
    }
    
# Extract the domain
- context: "tokens := ctx.username.split('@')"
- context: "domain := context.tokens.size() &gt; 1 ? context.tokens[1] : 'default'"

# Using the domain, extract the realm from the map. Route to default, if no valid domain found.
- context: "realm := context.idsMap.exists(x, x == context.domain) ? context.idsMap[context.domain] : 'invalid'"

# Use the realm parameter to route the login flow to the appropriate end-point.
# If the realm has been deduced to be default, route the flow to the default login endpoint.

- if:
    match: context.domain == "in.ibm.com"
    block:
        - return: &gt;
            {
                'loginUrl': context.realm
            }
    elseifs:
        - match: context.domain == "gmail.com"
          block:
            - return: &gt; 
                {
                    'loginUrl': context.realm
                }
          elseifs:
            - match: context.realm == "invalid"
              block:
                - return: &gt;
                    {
                        'loginUrl': 'invalid'
                    }
              else:
                - return: &gt;
                    {
                        'loginUrl': 'https://' + ctx.__tenantid + '/idaas/mtfim/sps/idaas/login?runtime=true&amp;login_hint=' + ctx.username + '&amp;realm_hint=' + context.realm
                    }
</isv:inputParameter><isv:outputParameter id="json" name="JSON"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_1gkbetj</bpmn2:incoming><bpmn2:outgoing>Flow_0jyhfr1</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RedirectTask" id="isv_redirect_1693487627874_customId" name="Login Page Redirect"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter id="redirectUrl" name="redirectUrl">${S(workflow_context).prop("loginUrl").value()}</isv:inputParameter><isv:inputParameter id="callback" name="callback"/><isv:inputParameter id="signal" name="signal"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_1hxkj18</bpmn2:incoming><bpmn2:outgoing>Flow_0j7k9ud</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_0j7k9ud" sourceRef="isv_redirect_1693487627874_customId" targetRef="Event_0fzzuo8_customId"/><bpmn2:sequenceFlow id="Flow_1gkbetj" sourceRef="Event_0vtdtpv_customId" targetRef="isv_function_1693487621614_customId"/><bpmn2:exclusiveGateway id="Gateway_0pwnuro_customId"><bpmn2:incoming>Flow_0jyhfr1</bpmn2:incoming><bpmn2:outgoing>Flow_1hxkj18</bpmn2:outgoing><bpmn2:outgoing>Flow_015r7sv</bpmn2:outgoing></bpmn2:exclusiveGateway><bpmn2:sequenceFlow id="Flow_0jyhfr1" sourceRef="isv_function_1693487621614_customId" targetRef="Gateway_0pwnuro_customId"/><bpmn2:sequenceFlow id="Flow_1hxkj18" name="Valid domain" sourceRef="Gateway_0pwnuro_customId" targetRef="isv_redirect_1693487627874_customId"><bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression">${S(workflow_context).prop("loginUrl").value() != "invalid"}</bpmn2:conditionExpression></bpmn2:sequenceFlow><bpmn2:serviceTask camunda:class="com.ibm.security.access.workflow.camunda.customTaskListener.RenderHTMLTask" id="isv_page_1701268906329_customId" name="Error Page"><bpmn2:extensionElements><isv:inputOutput><isv:inputParameter id="themeId" name="themeId">67cafc3b-f8d6-490a-b654-1bc16ec899d3</isv:inputParameter><isv:inputParameter id="templatename" name="templateName">custom_page2</isv:inputParameter><isv:inputParameter id="callback" name="callback"/><isv:inputParameter id="signal" name="signal"/></isv:inputOutput></bpmn2:extensionElements><bpmn2:incoming>Flow_015r7sv</bpmn2:incoming><bpmn2:outgoing>Flow_0bd3oto</bpmn2:outgoing></bpmn2:serviceTask><bpmn2:sequenceFlow id="Flow_015r7sv" name="" sourceRef="Gateway_0pwnuro_customId" targetRef="isv_page_1701268906329_customId"><bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression">${S(workflow_context).prop("loginUrl").value() == "invalid"}</bpmn2:conditionExpression></bpmn2:sequenceFlow><bpmn2:sequenceFlow id="Flow_0bd3oto" sourceRef="isv_page_1701268906329_customId" targetRef="Event_0fzzuo8_customId"/></bpmn2:process><bpmn2:message id="Message_08k7kfh" name="ifa"/><bpmn2:message id="Message_17apt1g" name="errorCondition"/><bpmn2:message id="Message_16zu7nh" name="errorCondition"/><bpmn2:message id="Message_18zyrh4" name=""/><bpmndi:BPMNDiagram id="BPMNDiagram_1"><bpmndi:BPMNPlane bpmnElement="identity_source_routing" id="BPMNPlane_1"><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_0onayf9" color:border-color="#161616" id="Event_0onayf9_di"><dc:Bounds height="40" width="126" x="257" y="-30"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_page_1693487581300_customId" color:border-color="#161616" id="Activity_1cb2gm9_di"><dc:Bounds height="76" width="188" x="226" y="62"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_0vtdtpv_customId" color:border-color="#161616" id="Event_0vtdtpv_di"><dc:Bounds height="36" width="36" x="302" y="182"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Event_0fzzuo8_customId" color:border-color="#161616" id="Event_0fzzuo8_di"><dc:Bounds height="40" width="126" x="257" y="680"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_function_1693487621614_customId" color:border-color="#161616" id="Activity_06fobbt_di"><dc:Bounds height="76" width="188" x="226" y="262"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="isv_redirect_1693487627874_customId" color:border-color="#161616" id="Activity_0wiw6z3_di"><dc:Bounds height="76" width="188" x="396" y="472"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#161616" bpmnElement="Gateway_0pwnuro_customId" color:border-color="#161616" id="Gateway_0pwnuro_di" isMarkerVisible="true"><dc:Bounds height="50" width="50" x="295" y="375"/></bpmndi:BPMNShape><bpmndi:BPMNShape bioc:stroke="#175ffe" bpmnElement="isv_page_1701268906329_customId" color:border-color="#175ffe" id="Activity_1dradwf_di"><dc:Bounds height="76" width="188" x="56" y="472"/><bpmndi:BPMNLabel/></bpmndi:BPMNShape><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_1w02h0s" color:border-color="#161616" id="Flow_1w02h0s_di"><di:waypoint x="320" y="10"/><di:waypoint x="320" y="62"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0x5fq5m" color:border-color="#161616" id="Flow_0x5fq5m_di"><di:waypoint x="320" y="138"/><di:waypoint x="320" y="182"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0j7k9ud" color:border-color="#161616" id="Flow_0j7k9ud_di"><di:waypoint x="490" y="548"/><di:waypoint x="490" y="700"/><di:waypoint x="383" y="700"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_1gkbetj" color:border-color="#161616" id="Flow_1gkbetj_di"><di:waypoint x="320" y="218"/><di:waypoint x="320" y="262"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0jyhfr1" color:border-color="#161616" id="Flow_0jyhfr1_di"><di:waypoint x="320" y="338"/><di:waypoint x="320" y="375"/></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_1hxkj18" color:border-color="#161616" id="Flow_1hxkj18_di"><di:waypoint x="345" y="400"/><di:waypoint x="490" y="400"/><di:waypoint x="490" y="472"/><bpmndi:BPMNLabel color:color="#161616"><dc:Bounds height="16" width="81" x="380" y="382"/></bpmndi:BPMNLabel></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_015r7sv" color:border-color="#161616" id="Flow_015r7sv_di"><di:waypoint x="295" y="400"/><di:waypoint x="150" y="400"/><di:waypoint x="150" y="472"/><bpmndi:BPMNLabel><dc:Bounds height="47" width="56" x="176" y="382"/></bpmndi:BPMNLabel></bpmndi:BPMNEdge><bpmndi:BPMNEdge bioc:stroke="#161616" bpmnElement="Flow_0bd3oto" color:border-color="#161616" id="Flow_0bd3oto_di"><di:waypoint x="150" y="548"/><di:waypoint x="150" y="700"/><di:waypoint x="257" y="700"/></bpmndi:BPMNEdge></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn2:definitions>